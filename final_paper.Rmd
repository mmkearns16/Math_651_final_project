---
title: "Math 651 Final Project"
author: "Mary Peng, Hillary Dunn, and Max Kearns"
date: "December 17, 2018"
output: 
  pdf_document:
    number_sections: true
---

```{r setup, include=FALSE, cache = T}
knitr::opts_chunk$set(echo = FALSE, comment = NA)
base<-read.csv('data/base_data.csv', stringsAsFactors = F)
P__disp <- function(x) {
  pr <- sum(residuals(x, type="pearson")^2)
  dispersion <- pr/x$df.residual
  c(pr, dispersion)
}
library(dplyr)
library(qpcR)
library(MuMIn)

base.total = base[which(base$year!=2016),]
Olympic = base.total[,c(2,3,4,5,6,7,8)]

#Clean the data (Mary to add)

#Make new dataframe with GDP / capita
Olympic_v2 <- data.frame(year = Olympic$year, country = Olympic$country, count = Olympic$count, log_pop = log(Olympic$pop), log_gdp_pcap = log(Olympic$gdp/Olympic$pop), host = Olympic$host, comm_soviet = Olympic$comm_soviet)
```

# Abstract 

# Introduction

##### needs editing 

Every four summers, the Olympic Games become the center of the world’s attention, as elite athletes seek honor for both themselves and for their countries. Many countries associate tremendous national pride with their medal counts, since a nation’s athletic competence also projects its soft power. For this last reason, some governments invest generously in their sports programs, in hopes of an elevated medal count in the next Olympics.

Given the fierce competition and high profile nature of medal counts, one may wonder what factors influence the number of medals that a country wins at the summer Olympics. Certainly countries with the largest economies and populations, such as the United States and China, commonly dominate the top of the billboard. However, Azerbaijan, which ranks 91st in population and 72nd in total GDP, also ranked in the top 20 countries by total medal count in the 2016 Summer Olympics. 

Our team will develop multiple regression models using various predictors, such as GDP, population size, size of athletic investment, and geographic location, to predict medal count. We will build the model on countries’ total medal count for the 2004, 2008, and 2012 Olympics, and then project the model onto the 2016 Olympics to understand the accuracy of the model’s predictions. 

# Methods and Materials

## Data 

The purpose of this reasearch is to determine whether there is a predictive relationship between popluation, GDP per capita, being a host nation, or at one point being a Communist nation or a member of the Soviet Union and number of medals won at the Olympics in the associated year by country.

### EDA--choose what we want to keep, and then format as figures in Appendix

As we can see IN FIGURE..., the average number of medals won by a country in a year is 11.79 medals and the minimum number of medals is one. This is meaningful because this means we are only assessing countries that have won at least one medal in at least one of the years we are analyzing.

Below we see that the medal count is distributed exponentially, which could indicate a need to transform the response variable if we need to fit a linear regression model.

$X_1$: This variable indicates population of people in the country in the associated year. Below, we can see a histogram of the population data. On the left, is the original distribution of the data points and on the right, we've transformed the data to look more normally distributed.

$X_2$: This variable indicates GDP per capita in the associated year. Below, we can see a histogram of the GDP per capita data. On the left, is the original distribution of the data points and on the right, we've transformed the data to look more normally distributed.

$X_3$: This binary predictor variable indicates with a 1 if a country hosted the Olympics within the previous 8 years, whether the country is hosting the Olympics in that year, or if the country is hosting within 8 years in the future. Of all the data points, 25 are classified as host within 8 years prior, current host or future host within 8 years. This makes sense because we are considering 5 years in our training data and each year has five countries that can be classified by this predictor variable.\
$X_4$: This binary predictor variable indicates whether the country was once a member of the Soviet Union or if they were indicated as ever being a Communist country. From __________ we aggregated a binary predictor variable that identifies countries that were once members of the Soviet Union or at one time classified as communist countries. 111 data points are classified as former Soviet Union or Communist.(INSERT SOURCE AGAIN???)

In addition to the predictors and response variable, each data point has an associated country and year.

INSERT WHY WE DECIDED TO GO WITH LOG OF VARIABLES


To properly determine an ideal model for the data, we need to address the relationships between variables. We can do this be analyzing both the scatterplot matrix of variables and the correlation matrix.

The scatterplot matrix does not obviously show us many relationships between the predictor variables and their effect on the response variable. While there might be a relationship between the log of the population and the medal count, it is difficult to determine from the plot if this is a linear relationship. Additional information can be collected from the correlation matrix below.

This correlation matrix suggests that collinearity between variables will not be a significant issue. The most significant correlation between predictor variables is between the log of the GDP per capita and the indicator of Communism or Soviet Union inclusion variable. However, the correlation coefficient is only -0.2989.

Summary of Medal Count:
```{r, include = F, echo=FALSE}
library(knitr)
summary(base$count)
```
Distribution of Medal Count:

```{r medal_count_hist, include = F, echo=FALSE}
hist(base$count)
```

Distribution of Medal Count in 2008:

```{r count_2008_hist, echo=FALSE, include = F}
hist(base[which(base$year == c("2008")),c("count")])
```

GDP Summary:
```{r, echo=FALSE, include = F}
summary(base$gdp)
```
Population Summary:
```{r, echo=FALSE, include = F}
summary(base$pop)
```
Total Count of Communist / comm_soviet Countries:
```{r, echo=FALSE, include = F}
sum(base$comm_soviet)
nrow(base)-sum(base$comm_soviet)
```
Count of host, hosted within 8 years prior, or will be hosting within 8 years:
```{r, echo=FALSE, include = F}
sum(base$host)
```

Histograms of Population:
```{r pop_hists, echo=FALSE, include = F}
par(mfrow=c(1,2))
#Histogram Population
hist(base$pop,main = "Untransformed",xlab = "Population")
#Histogram log(Population)
hist(log(base$pop),main = "Transformed",xlab = "log(Population)")
```

Boxplot of $\text{log}(\text{GDP})$:
```{r log_gdp_box, echo=FALSE, include = F}
#Log(GDP)
boxplot(log(base$gdp),ylab = "log(GDP)")
```

Boxplot of $\text{log}(\text{Population})$:
```{r log_pop_box, echo=FALSE, include = F}
#log(Population)
boxplot(log(base$pop),ylab = "log(Population)")
```

Scatterplot Matrix of Variables:
```{r scatter_mat, echo=FALSE, include = F}
pairs(Olympic[,c(2,4,5,6,7)])
```

Correlation Matrix of Predictor Variables and Response Variable:
```{r corr_mat, include = F, echo=FALSE}
kable(cor(Olympic[,c(2,4,5,6,7)]))
```

## Model Building and Selection

### Linear Model

```{r, include=FALSE}
library(leaps)
#CP
olympic.leapCP <- leaps(y=log(Olympic_v2$count), x=Olympic_v2[,4:7])
#R2a
olympic.leapR2a <- leaps(y=log(Olympic_v2$count), x=Olympic_v2[,4:7], method = 'adjr2')

  ### Code for AIC
xList <- names(Olympic_v2)[4:7]
  #### Remove the last row that has all False's
vec <- olympic.leapCP$which
  ### Name the columns in the grid
names(vec) <- paste("X", 1:4, sep="")
  #### Build matrix of formula for every row
allModelsList <- apply(vec, 1, function(x) as.formula(
  paste(c("count ~ 1", xList[x]), collapse = "+")))
  ### Calculate the coefficients for all 16 models
allModelsResults <- lapply(allModelsList, 
                           function(x) lm(x, data=Olympic_v2))

```

```{r, eval=FALSE, include=FALSE}
#PRESS (Non-Mac)
library(qpcR)
olympic.lm = PRESS(lm(log(count)~log_pop+log_gdp_per_cap+host+comm_soviet))
olympic.lmX1 = PRESS(lm(log(count)~log_pop))
olympic.lmX2 = PRESS(lm(log(count)~log_gdp_per_cap))
olympic.lmX3 = PRESS(lm(log(count)~host))
olympic.lmX4 = PRESS(lm(log(count)~comm_soviet))
olympic.lmX1X2 = PRESS(lm(log(count)~log_pop+log_gdp_per_cap))
olympic.lmX1X3 = PRESS(lm(log(count)~log_gdp_per_cap+host))
olympic.lmX1X4 = PRESS(lm(log(count)~log_pop+comm_soviet))
olympic.lmX2X3 = PRESS(lm(log(count)~log_gdp_per_cap+host))
olympic.lmX2X4 = PRESS(lm(log(count)~log_gdp_per_cap+comm_soviet))
olympic.lmX3X4 = PRESS(lm(log(count)~host+comm_soviet))
olympic.lmX1X2X3 = PRESS(lm(log(count)~log_pop+log_gdp_per_cap+host))
olympic.lmX1X2X4 = PRESS(lm(log(count)~log_pop+log_gdp_per_cap+comm_soviet))
olympic.lmX2X3X4 = PRESS(lm(log(count)~log_gdp_per_cap+host+comm_soviet))
olympic.lmX1X3X4 = PRESS(lm(log(count)~log_pop+host+comm_soviet))

olympic.lm_press <- rbind(olympic.lmX1$stat,
                          olympic.lmX3$stat,
                          olympic.lmX2$stat,
                          olympic.lmX4$stat,
                          olympic.lmX1X3$stat,
                          olympic.lmX1X2$stat,
                          olympic.lmX1X4$stat,
                          olympic.lmX2X3$stat,
                          olympic.lmX3X4$stat,
                          olympic.lmX2X4$stat,
                          olympic.lmX1X2X3$stat,
                          olympic.lmX1X2X4$stat,
                          olympic.lmX1X3X4$stat,
                          olympic.lmX2X3X4$stat,
                          olympic.lm$stat)
```


### Generalized Linear Model

The first choice for a glm is typically a Poisson model, which may provide a reasonable model for these data. This generalized model was created with the same variables as the linear model; population, GDP per capita, the host dummy variable, and the communist/soviet dummy variable. Like the linear model, the population and GDP per capita were log-transformed, but in this model it is unnecessary to transform the medal count. The full poisson model showed highly significant parameters, but the dispersion of this model was much greater than 1 (disp. = 6.621), so a negative binomial model would likely provide a better fit for these data. 

```{r, comment = NA, include=F}
Olympic.pois<-glm(count~log_pop + log_gdp_pcap + host + comm_soviet, data = Olympic_v2, family = poisson)
P__disp(Olympic.pois)
```

```{r negative binomial, echo = F}
library(MASS)
olympic.nb <- glm.nb(count~log_pop + log_gdp_pcap + host + comm_soviet, data = Olympic_v2)
```

```{r nb leaps, echo = F}
library(leaps)
olympic.nb_leap <- leaps(y=Olympic_v2$count, x=Olympic_v2[,4:7])
Cp.nb<-round(olympic.nb_leap$Cp, 2)

which<-olympic.nb_leap$which
rownames(which) <-NULL
colnames(which)<-c('Pop', 'GDP/C', 'Host', 'Soviet')
```

A negative binomial regression model assumes that dispersion is greater than 1, which is consistent with these data. Therefore, it allows for more accurate tests of the parameters. Among the negative binomial models, the best model again proved to be the full model, after a comparison of AIC between all subsets of variables (Table 2).

```{r weird algorithm thing, echo = F}
xList <- names(Olympic_v2)[4:7]
vec <- olympic.nb_leap$which

#Name the columns in the grid
names(vec) <- paste("X", 1:4, sep="")

#Build matrix of formula for every row
allModelsList <- apply(vec, 1, function(x) as.formula(
  paste(c("count ~ 1", xList[x]), collapse = "+")))

#Calculate the coefficients for all 16 models
allModelsResults <- lapply(allModelsList, 
                           function(x) glm.nb(x, data=Olympic_v2))


AIC.nb<-matrix(unlist(lapply(allModelsResults, function(x) round(extractAIC(x),2))), ncol = 2, byrow = T)[,2]
library(knitr)
```

# Results 

# Discussion and Conclusions

\newpage
# Bibliography

\newpage
# Appendix A

```{r, echo = F}
kable(cbind(which, Parameters = olympic.nb_leap$size, Cp.nb, AIC.nb), caption = 'Model Selection Diagnostics for a Negative Binomial Model', format.args = list(justify = 'centre'))
```

```{r, echo=FALSE, fig.pos='h', out.extra = '', fig.cap='This is a test figure.'}
par(mfrow=c(1,2))
#Histogram Population
hist(base$pop,main = "Untransformed",xlab = "Population")
#Histogram log(Population)
hist(log(base$pop),main = "Transformed",xlab = "log(Population)")
```

```{r, echo = F}
tab<-summary(olympic.nb)$coefficients
colnames(tab)[4]<-'p-value'
rownames(tab)<-c('Intercept', 'log(Population)', 'log(GDP/Capita)', 'Host', 'Comm/Soviet')
kable(tab, format.args = list(justify = 'centre'), caption = 'Negative Binomial Model Coefficients')
```

\newpage

# Appendix B
```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```













